{% extends "index.html" %}

{% block content %}
<main class="container shop-section">
    <!-- Header de Secci√≥n -->
    <div style="text-align: center; margin-bottom: 40px;">
        <h2 style="font-size: 2rem; font-weight: 700;">Cat√°logo</h2>
        <p style="color: var(--secondary);">Explora nuestros rangos y mejoras disponibles</p>
    </div>

    <!-- Grid de Productos -->
    <div id="products-container" class="grid">
        <!-- Los productos se inyectan aqu√≠ con JS -->
    </div>
</main>

<!-- Modal de Compra -->
<div class="modal-overlay" id="purchase-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 style="font-size: 1.25rem;">Confirmar Compra</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <div style="margin-bottom: 24px;">
            <p style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 4px;">Est√°s comprando:</p>
            <h2 id="modal-product-name" style="font-size: 1.5rem; color: white;">Producto</h2>
            <p id="modal-product-price" style="font-size: 1.2rem; color: var(--accent); font-weight: 600;">$0.00</p>
        </div>

        <form id="purchase-form">
            <div class="input-group">
                <label class="input-label" for="username">Usuario de Minecraft</label>
                <input type="text" id="username" class="input-field" placeholder="Ej: Steve" required
                    autocomplete="off">
                <p style="font-size: 0.8rem; color: var(--secondary); margin-top: 6px;">
                    <i class="fa-solid fa-circle-info"></i> Aseg√∫rate de escribirlo correctamente.
                </p>
            </div>

            <button type="submit" class="btn btn-accent btn-full">
                Ir al Pago <i class="fa-solid fa-lock" style="margin-left: 8px;"></i>
            </button>
        </form>
    </div>
</div>

<script>
    // Datos de ejemplo (idealmente vendr√≠an de una API)
    const products = [
        { id: 'vip', name: 'Rango VIP', price: 5, icon: 'üíé', desc: 'Acceso b√°sico a comandos vip' },
        { id: 'mvp', name: 'Rango MVP', price: 15, icon: 'üëë', desc: 'Vuelo, kits y m√°s ventajas' },
        { id: 'coins-50k', name: '50,000 Monedas', price: 3, icon: 'üí∞', desc: 'Monedas para la econom√≠a del servidor' },
        { id: 'fly', name: 'Permiso Fly', price: 8, icon: 'üïäÔ∏è', desc: 'Vuela libremente por el mundo' }
    ];

    const currencySymbol = "{{ config.currency_symbol }}";

    function renderProducts() {
        const container = document.getElementById('products-container');
        container.innerHTML = products.map(p => `
            <div class="card">
                <div class="card-icon">${p.icon}</div>
                <h3>${p.name}</h3>
                <p class="card-price">${currencySymbol}${p.price} <span>{{ config.currency }}</span></p>
                <p style="color: var(--secondary); font-size: 0.9rem; margin-bottom: 20px;">
                    ${p.desc || 'Mejora tu experiencia en el servidor.'}
                </p>
                <div class="card-actions">
                    <button onclick="openModal('${p.id}', '${p.name}', ${p.price})" class="btn btn-outline btn-full">
                        Comprar
                    </button>
                </div>
            </div>
        `).join('');
    }

    let selectedProduct = null;
    const modal = document.getElementById('purchase-modal');

    function openModal(id, name, price) {
        selectedProduct = { id, name, price };
        document.getElementById('modal-product-name').textContent = name;
        document.getElementById('modal-product-price').textContent = `${currencySymbol}${price} {{ config.currency }}`;
        modal.classList.add('active');
        document.getElementById('username').focus();
    }

    function closeModal() {
        modal.classList.remove('active');
        selectedProduct = null;
    }

    // Cerrar al hacer click fuera
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    document.getElementById('purchase-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();

        if (!username || !selectedProduct) return;

        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: selectedProduct.id,
                    username: username
                })
            });

            const data = await response.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert('Error: ' + (data.error || 'Algo sali√≥ mal'));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (err) {
            alert('Error de conexi√≥n');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    renderProducts();
</script>
{% endblock %}